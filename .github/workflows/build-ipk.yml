name: Build NaiveProxy-Luci IPK
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Install dependencies
      run: |
        sudo apt-get update
        # 尝试更精确地替换 azure 源为官方源，并验证替换是否成功
        sudo sed -i 's|^deb http://azure.archive.ubuntu.com/ubuntu |deb http://archive.ubuntu.com/ubuntu/ |g' /etc/apt/sources.list
        sudo sed -i 's|^deb-src http://azure.archive.ubuntu.com/ubuntu |deb-src http://archive.ubuntu.com/ubuntu/ |g' /etc/apt/sources.list

        # 打印 sources.list 文件内容，用于检查 azure 源是否被替换
        cat /etc/apt/sources.list

        sudo apt-get update
        # 启用 multiverse 仓库 (如果之前未启用，或者再次尝试确保启用)
        sudo add-apt-repository multiverse || true
        sudo apt-get update
        sudo apt-get install -y build-essential subversion libncurses5-dev zlib1g-dev gawk gcc multiverse-dev texinfo zlib1g-dev lbzip2 git
        sudo apt-get install -y python3 python2-minimal libpython3-dev python3-pip
        pip3 install --upgrade pip
        pip3 install shadowsocks-libev
    # Configure and compile NaiveProxy-Luci
    - name: Build IPK package
      run: |
        # Assuming you have OpenWrt SDK setup in 'openwrt' directory
        cd openwrt
        # Update feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        # Copy the custom package (NaiveProxy-Luci) into package directory
        cp -r ../../packages/luci-app-naiveproxy ./package/feeds/custom/luci-app-naiveproxy
        # Update and build
        make defconfig
        make -j4 download
        make -j4 V=s
        # Package the IPK
        make package/index
        # Collect the generated IPK
        cp bin/packages/flower/luci-app-naiveproxy_*.ipk ../release/
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: naiveproxy-luci.ipk
        path: release/luci-app-naiveproxy_*.ipk
